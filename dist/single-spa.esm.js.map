{"version":3,"file":"single-spa.esm.js","sources":["../src/utils.ts","../src/types.ts","../src/lifecycle/bootstrap.ts","../src/lifecycle/mount.ts","../src/lifecycle/unmount.ts","../src/application/apps.ts","../src/navigation/overwriteEventsAndHistory.ts","../src/application/registerApplication.ts","../src/start.ts","../src/index.ts"],"sourcesContent":["import parse from 'node-html-parser'\n\nexport function isPromise(func: any) {\n    if (typeof func === 'function' && typeof func.then === 'function') {\n        return true\n    }\n}\n\nexport async function parseHTMLandLoadScripts(url: string) {\n    const html = await loadHtml(url)\n    const scripts = parse(html).querySelectorAll('script')\n    const promise = scripts.map(script => loadScript(script.attrs.src))\n    await Promise.all(promise)\n}\n\nexport function loadHtml(url: string) {\n    return new Promise<string>((resolve, reject) => {\n        const xhr = new XMLHttpRequest()\n        xhr.onload = (res: any) => {\n            resolve(res.target.response)\n        }\n\n        xhr.onerror = reject\n        xhr.onabort = reject\n\n        xhr.open('get', url)\n        xhr.send()\n    })\n}\n\nexport function loadScript(url: string) {\n    return new Promise<void>((resolve, reject) => {\n        const xhr = new XMLHttpRequest()\n        xhr.onload = (res: any) => {\n            const script = document.createElement('script')\n            script.text = res.target.response\n            document.querySelector('head')?.appendChild(script)\n            resolve()\n        }\n\n        xhr.onerror = reject\n        xhr.onabort = reject\n\n        xhr.open('get', url)\n        xhr.send()\n    })\n}","export interface AnyObject {\n    [key: string]: any\n}\n\nexport enum AppStatus {\n    BEFORE_BOOTSTRAP = 'BEFORE_BOOTSTRAP',\n    BOOTSTRAPPED = 'BOOTSTRAPPED',\n    BEFORE_MOUNT = 'BEFORE_MOUNT',\n    MOUNTED = 'MOUNTED',\n    BEFORE_UNMOUNT = 'BEFORE_UNMOUNT',\n    UNMOUNTED = 'UNMOUNTED',\n    LOAD_ERROR = 'LOAD_ERROR',\n    SKIP_BECAUSE_BROKEN = 'SKIP_BECAUSE_BROKEN',\n}\n\nexport interface Application {\n    name: string\n    activeRule: Function | string\n    customProps: AnyObject\n    host?: string\n    status?: AppStatus\n    loadApp: () => Promise<any>\n    bootstrap?: () => Promise<any>\n    mount?: (props: AnyObject) => Promise<any>\n    unmount?: (props: AnyObject) => Promise<any>\n}","import { isPromise } from 'src/utils'\nimport { Application, AppStatus } from '../types'\n\nexport default async function bootstrapApp(app: Application) {\n    const { bootstrap, mount, unmount } = await app.loadApp()\n    \n    if (isPromise(bootstrap) && isPromise(mount) && isPromise(unmount)) {\n        throw Error('The lifecycle function must be a Promise')\n    }\n\n    app.bootstrap = bootstrap\n    app.mount = mount\n    app.unmount = unmount\n    \n    return (app as any).bootstrap().then(() => {\n        app.status = AppStatus.BOOTSTRAPPED\n    })\n}","import { Application, AppStatus } from '../types'\n\nexport default function mountApp(app: Application): Promise<any> {\n    app.status = AppStatus.BEFORE_MOUNT\n    return (app as any).mount(app.customProps || {}).then(() => {\n        app.status = AppStatus.MOUNTED\n    })\n}","import { Application, AppStatus } from '../types'\n\nexport default function unMountApp(app: Application): Promise<any> {\n    app.status = AppStatus.BEFORE_UNMOUNT\n    return (app as any).unmount(app.customProps || {}).then(() => {\n        app.status = AppStatus.UNMOUNTED\n    })\n}","import bootstrapApp from '../lifecycle/bootstrap'\nimport mountApp from '../lifecycle/mount'\nimport unMountApp from '../lifecycle/unmount'\nimport { Application, AppStatus } from '../types'\n\nexport const apps: Application[] = []\n\nexport async function loadApps() {\n    const toLoadApp = getAppsWithStatus(AppStatus.BEFORE_BOOTSTRAP)\n    const toUnMountApp = getAppsWithStatus(AppStatus.MOUNTED)\n    \n    const loadPromise = toLoadApp.map(bootstrapApp)\n    const unMountPromise = toUnMountApp.map(unMountApp)\n    await Promise.all([...loadPromise, ...unMountPromise])\n    \n    const toMountApp = [\n        ...getAppsWithStatus(AppStatus.BOOTSTRAPPED),\n        ...getAppsWithStatus(AppStatus.UNMOUNTED),\n    ]\n    \n    await toMountApp.map(mountApp)\n}\n\nfunction getAppsWithStatus(status: AppStatus) {\n    const result: Application[] = []\n    apps.forEach(app => {\n        // tobootstrap or tomount\n        if (isActive(app) && app.status === status) {\n            switch (app.status) {\n                case AppStatus.BEFORE_BOOTSTRAP:\n                case AppStatus.BOOTSTRAPPED:\n                case AppStatus.UNMOUNTED:\n                    result.push(app)\n                    break\n            }\n        } else if (app.status === AppStatus.MOUNTED && status === AppStatus.MOUNTED) {\n            // tounmount\n            result.push(app)\n        }\n    })\n\n    return result\n}\n\nfunction isActive(app: Application) {\n    return typeof app.activeRule === 'function' && app.activeRule(window.location)\n}","import { loadApps } from '../application/apps'\n\nconst originalPushState = window.history.pushState\nconst originalReplaceState = window.history.replaceState\n\nexport default function overwriteEventsAndHistory() {\n    window.history.pushState = function (state: any, title: string, url: string) {\n        const result = originalPushState.call(this, state, title, url)\n        loadApps()\n        return result\n    }\n    \n    window.history.replaceState = function (state: any, title: string, url: string) {\n        const result = originalReplaceState.call(this, state, title, url)\n        loadApps()\n        return result\n    }\n    \n    window.addEventListener('popstate', () => {\n        loadApps()\n    }, true)\n    \n    window.addEventListener('hashchange', () => {\n        loadApps()\n    }, true)\n}\n","import { Application, AppStatus } from '../types'\nimport { apps } from './apps'\n\nexport default function registerApplication(app: Application) {\n    if (typeof app.activeRule === 'string') {\n        const path = app.activeRule\n        app.activeRule = (location = window.location) => location.pathname === path\n    }\n\n    app.status = AppStatus.BEFORE_BOOTSTRAP\n    apps.push(app)\n}","import { loadApps } from './application/apps'\n\nlet isStarted = false\nexport default function start() {\n    if (!isStarted) {\n        isStarted = true\n        loadApps()\n    }\n}\n\nexport function isStart() {\n    return isStarted\n}","import overwriteEventsAndHistory from './navigation/overwriteEventsAndHistory'\nexport { default as registerApplication } from './application/registerApplication'\nexport { default as start } from './start'\n\ndeclare const window: any\n\n// 是否运行在 single spa 下\nwindow.__IS_SINGLE_SPA__ = true\n\noverwriteEventsAndHistory()"],"names":[],"mappings":"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"}